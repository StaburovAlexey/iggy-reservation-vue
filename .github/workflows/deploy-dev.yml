name: deploy-dev
on:
  push:
    branches: [new-api]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - name: Create .env.development
        run: |
          cat > .env.development <<EOF
          VITE_APP_API=${VITE_APP_API}
          EOF
        env:
          VITE_APP_API: ${{ secrets.VITE_APP_API }}
      - run: npm run build:dev

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Connectivity check (DNS + TCP:21)
        run: |
          HOST="${{ secrets.FTP_HOST }}"; PORT="${{ secrets.FTP_PORT }}"; [ -z "$PORT" ] && PORT=21
          echo "Host: ${HOST}  Port: ${PORT}"
          echo '— DNS resolution:'
          getent hosts "${HOST}" || nslookup "${HOST}" || true
          echo '— TCP port probe:'
          (timeout 7 bash -lc "exec 3<>/dev/tcp/${HOST}/${PORT}") && echo 'TCP reachable' || (echo 'TCP unreachable (blocked/closed or host down)'; exit 1)
          echo '— TLS handshake (FTP STARTTLS):'
          openssl s_client -starttls ftp -connect "${HOST}:${PORT}" -brief -servername "${HOST}" </dev/null || true

      - name: Debug FTPS list (explicit TLS 21)
        run: |
          HOST="${{ secrets.FTP_HOST }}"; PORT="${{ secrets.FTP_PORT }}"; [ -z "$PORT" ] && PORT=21
          FTP_USER="${{ secrets.FTP_USER }}"; FTP_PASS="${{ secrets.FTP_PASS }}"
          if [ -z "$FTP_USER" ] || [ -z "$FTP_PASS" ]; then echo "FTP_USER/FTP_PASS не заданы"; exit 1; fi
          lftp ftp://"${HOST}":"${PORT}" -e "\
            set net:max-retries 1; \
            set net:timeout 30; \
            set net:reconnect-interval-base 5; \
            set dns:order inet; \
            set ftp:passive-mode on; \
            set ftp:ssl-allow yes; \
            set ftp:ssl-force yes; \
            set ftp:ssl-protect-data yes; \
            set ssl:verify-certificate no; \
            set ftp:prefer-epsv false; \
            debug 9; \
            user \"$FTP_USER\" \"$FTP_PASS\"; \
            cls -l /var/www/reserve.dev.alexeystaburov.ru; \
            bye"


      - name: Deploy via FTPS mirror
        run: |
          HOST="${{ secrets.FTP_HOST }}"; PORT="${{ secrets.FTP_PORT }}"; [ -z "$PORT" ] && PORT=21
          FTP_USER="${{ secrets.FTP_USER }}"; FTP_PASS="${{ secrets.FTP_PASS }}"
          if [ -z "$FTP_USER" ] || [ -z "$FTP_PASS" ]; then echo "FTP_USER/FTP_PASS не заданы"; exit 1; fi
          lftp ftp://"${HOST}":"${PORT}" -e "\
            set net:max-retries 1; \
            set net:timeout 60; \
            set net:reconnect-interval-base 5; \
            set dns:order inet; \
            set ftp:passive-mode on; \
            set ftp:ssl-allow yes; \
            set ftp:ssl-force yes; \
            set ftp:ssl-protect-data yes; \
            set ssl:verify-certificate no; \
            set ftp:prefer-epsv false; \
            user \"$FTP_USER\" \"$FTP_PASS\"; \
            mirror -R --delete --verbose dist /www/reserve.dev.alexeystaburov.ru; \
            bye"

      - name: Telegram notify success
        if: ${{ success() }}
        run: |
          COMMIT="${GITHUB_SHA::7}"
          MSG="$(printf "✅ Deploy OK\nrepo: %s\nbranch: %s\ncommit: %s\nauthor: %s\nhost: %s\npath: /www/reserve.dev.alexeystaburov.ru/\nrun: %s/%s/actions/runs/%s" \
            "$GITHUB_REPOSITORY" "$GITHUB_REF_NAME" "$COMMIT" "$GITHUB_ACTOR" "${{ secrets.FTP_HOST }}" "$GITHUB_SERVER_URL" "$GITHUB_REPOSITORY" "$GITHUB_RUN_ID")"
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=$MSG" \
            --data "parse_mode=HTML"

      - name: Telegram notify failure
        if: ${{ failure() }}
        run: |
          COMMIT="${GITHUB_SHA::7}"
          MSG="$(printf "❌ Deploy FAILED\nrepo: %s\nbranch: %s\ncommit: %s\nauthor: %s\nrun: %s/%s/actions/runs/%s" \
            "$GITHUB_REPOSITORY" "$GITHUB_REF_NAME" "$COMMIT" "$GITHUB_ACTOR" "$GITHUB_SERVER_URL" "$GITHUB_REPOSITORY" "$GITHUB_RUN_ID")"
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=$MSG" \
            --data "parse_mode=HTML"
